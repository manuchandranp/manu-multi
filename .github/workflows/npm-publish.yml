name: Publish NPM
on:
  workflow_call:
    inputs:
      jfrog-npm-repository:
        required: true
        type: string
      jfrog-url:
        required: true
        type: string
      node-version:
        required: true
        type: string
      package-json-file-path:
        required: true
        type: string
      prerelease:
        required: false
        type: boolean
      npm-distribution-tag:
        required: false
        type: string
    secrets:
      jfrog-access-token:  # This must be declared for secrets to be passed to the workflow
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Publish Package to NPM
        run: |
          npm config set registry ${{ inputs.jfrog-url }}
          npm config set //{{ inputs.jfrog-url }}:_authToken=${{ secrets.jfrog-access-token }}
          npm publish --registry ${{ inputs.jfrog-url }} --access public
  publish-npm:
  name: Publish NPM
  needs: build-and-test
  runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Use npm-publish workflow
      uses: ./.github/workflows/npm-publish.yml
      with:
        jfrog-npm-repository: ${{ env.NPM_REPOSITORY }}
        jfrog-url: ${{ env.JFROG_URL }}
        node-version: '24'
        package-json-file-path: 'package.json'
        prerelease: ${{ github.ref != 'refs/heads/main' }}
        npm-distribution-tag: ${{ github.ref == 'refs/heads/main' && 'latest' || '' }}
      env:
        JFROG_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}  # Use secrets for access token        
          
          
